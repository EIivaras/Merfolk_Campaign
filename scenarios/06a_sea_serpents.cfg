#textdomain wesnoth-merfolk_campaign

[scenario]
    name= _ "Sea Serpents"
    map_file=06a_sea_serpents.map

    id=06a_sea_serpents
    next_scenario=07_the_prince

    {INTRO_AND_SCENARIO_MUSIC frantic.ogg loyalists.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}
    {EXTRA_SCENARIO_MUSIC transience.ogg}

    {DEFAULT_SCHEDULE_DUSK}

    {TURNS 29 24 19}
    victory_when_enemies_defeated=yes

    [side]
        side=1
        controller=human
        recruit=Merman Hunter,Merman Fighter,Mermaid Initiate
        team_name=good
        user_team_name= _ "Danielle"
        color=red

        {GOLD 300 200 100}
        x,y=15,1
        [leader]
            type=Enchantress Queen
            id=Kai
            name= _ "Danielle"
            facing=sw
        [/leader]
    [/side]

    [side]
        side=2
        controller=ai
        team_name=good
        canrecruit=no
        user_team_name= _ "Mirne’s Fleet"
        color=blue

        recruit=Fencer, Mage, Ruffian, Poacher

#ifndef EASY
        type=Duelist
#else
        type=Master at Arms
#endif
        id=Captain
        name= _ "Captain Mirne"
        canrecruit=yes
        [modifications]
            {TRAIT_FEARLESS}
        [/modifications]

        {GOLD 40 30 20}
        {INCOME 20 15 10}
    [/side]

    [side]
        side=3
        controller=ai
        team_name=good
        canrecruit=no
        user_team_name= _ "Rainur’s Fleet"

        gold=0
    [/side]

    [side]
        side=4
        controller=ai
        recruit=Water Snakelet, Spitting Serpent, Cuttle Fish, Great Seahorse, Roc, Sea Serpent, Water Serpent
        team_name=enemy
        user_team_name= _ "Sea Serpents"

        {GOLD 150 350 500}
        type=Sea Serpent
        id=Empress
        name= _ "Sea Empress"
    [/side]

    {LIMIT_RECRUITS 2 Ruffian {ON_DIFFICULTY 1 3 5}}
    {LIMIT_RECRUITS 2 Fencer {ON_DIFFICULTY 5 3 1}}
    {LIMIT_RECRUITS 2 Poacher {ON_DIFFICULTY 3 2 1}}
    {LIMIT_RECRUITS 2 Mage 1}

    [event]
        name=prestart
        # Add more shipwreks, one of them will have the dwarves. At the end, the spawned galleon carries them to elensefar, accompanied by danielle (so the units are added to the recall list for the next scenario and the transport galleon to the retinue).

        {PLACE_IMAGE "scenery/wreck.png" 33 27}
        {PLACE_IMAGE "scenery/wreck-2.png" 4 11}
        {PLACE_IMAGE "scenery/wreck-3.png" 34 19}
        {PLACE_IMAGE "scenery/wreck-2.png" 20 27}
        {PLACE_IMAGE "scenery/wreck.png" 5 34}
        {PLACE_IMAGE "scenery/shipwreck-1.png" 33 39}
        {MOVETO_MSG 33 27 (_ "Those rocks made good work of this vessel.")}
        {MOVETO_MSG 34 19 (_ "Ummm here are only remains and, oh wait, some gold!")}
        [+event]
            [gold]
                side=1
                amount={ON_DIFFICULTY 50 34 12}
            [/gold]
            [message]
                speaker=narrator
                message= _ "Found {ON_DIFFICULTY 50 34 12} pieces of gold."
            [/message]
        [/event]
        {MOVETO_MSG 20 27 (_ "Oh, what a nasty place to end up, there aren’t even the remains.")}
        {MOVETO_MSG 5 34 (_ "Nothing here.")}
        {MOVETO_MSG 4 11 (_ "I don’t think there is anyone alive h-")}
        [+event]
            [message]
                speaker=Captain
                message= _ "Aye, nay do not even bother, we retrieved what was left of that fallen vessel this sunrise."
            [/message]
        [/event]
        # Global variable for ship spawning mechanics
        [set_variable]
            name=spawned
            value=no
        [/set_variable]
        
        [set_variable]
            name=first_thunder
            value=yes
        [/set_variable]

        [unit]
            type=Thunder Galleon
            id=Flagship
            name= _ "Aground Flagship Calder"
            side=2
            x,y=15,11
            facing=n
            profile="portraits/humans/duelist.png"
            [modifications]
                {TRAIT_LOYAL_HERO}
            [/modifications]
        [/unit]
        {MODIFY_UNIT id=Flagship max_moves 0}
        {MODIFY_UNIT id=Flagship moves 0}
    [/event]

    [story]
        [part]
            story= _ "As Danielle and her soldiers journey further along the coast, they begin to encounter more and more Naga opposition. Some a senseless mob of ill equiped soldiers, and some elite fighting squads."
        [/part]

        [part]
            story= _ "As they get closer and closer to their destination, each day started to become a constant struggle to survive against their adversary."
        [/part]

        [part]
            story= _ "With the counsel of her general and advisors, Danielle decides to brave the open sea in travel rather than risk an overwhelming number of foes along the coast."
        [/part]

        [part]
            story= _ "As the party gets speed along a powerful current of water, they approach a volcanic area in the deep ocean. Straight ahead, in the distance, a ships flag is spotted."
        [/part]
    [/story]

    [event]
        name=start
        # Move animation for Danielle
        [move_unit]
            type="Mermaid Enchantress"
            x=15,10
            y=1,5
            side=1
        [/move_unit]
        {RECALL_KAI_RETINUE}
        [message]
            speaker=Captain
            #po: ye means you
            message= _ "Hail Mermaid. What brings ye to these forsaken waters?"
        [/message]

        [message]
            speaker=Kai
            message= _ "Naga invaded our homeland, and nearly destroyed our capital. Kai Krellis sent my party and me on a mission to find the source of the Naga invasion."
        [/message]

        [message]
            speaker=Captain
            #po: Aye is an interjection
            message= _ "Aye, I see that your soldiers are veterans of many battles. My name is Captain Mirne, at your service."
        [/message]

        [message]
            speaker=Kai
            message= _ "What brings you to these waters which are, as you said, forsaken."
        [/message]

        [message]
            speaker=Captain
            message= _ "We camped here only last night while we searched for provisions on the island. We came in the greatest ship ever constructed, our Flagship, Calder."
        [/message]

        [message]
            speaker=Kai
            message= _ "You mean, that ship agrounded over there?."
        [/message]
        {SCROLL_TO 15 11}
        [message]
            speaker=Captain
            message= _ "Alas for our ill fortune! My few ships were seperated from the rest of our greater fleet when we ran afoul with a terrible sea storm two moons ago. We were bound for Adril, coming from Elensefar, carrying weapons and supplies. But we ended up aground here while searching for any survivors, Calder was the last ship floating after the storm as far as the eye could see."
        [/message]

        [message]
            speaker=Kai
            message= _ "We have just been on a port, close to Wesnoth’s coast, we may be able to get you out of this one, Aresius, go to the port and grab a boat, we will be resting here until your return."
        [/message]

        [message]
            speaker=Aresius
            message= _ "I will be back as soon as possible."
        [/message]

        [move_unit]
            id=Aresius
            to_x=17
            to_y=1
        [/move_unit]
        [store_unit]
            [filter]
                id=Aresius
            [/filter]
            kill=yes
            variable=Aresius_stored_var
        [/store_unit]

        [message]
            speaker=Kai
            message= _ "Also our party desires to go to Elensefar, and seek out any information they may have pertaining to our quest. Do you bear any news from the Lord of the city?"
        [/message]

        [message]
            speaker=Captain
            #po: Nay means no. n' means them.
            message= _ "Nay, no news, but rumor I have n’ plenty.  When last we left, it was widely whispered that something terrible was happening to the water further up the great river.  That was some days ago now, and we know not what has happened since."
        [/message]

        [message]
            speaker=Kai
            message= _ "If the Lord of Elensefar may know something of our quest, we will certainly -"
        [/message]

        # Sea Empress sound effects
        {SCROLL_TO 18 26}
        [sound]
            name=rumble.ogg
            repeat=0
        [/sound]

        [delay]
            time=200
        [/delay]

        [sound]
            name=lich-die.ogg
            repeat=0
        [/sound]

        [music]
            name=suspense.ogg
            immediate=yes
        [/music]

        [message]
            speaker=Empress
            message= _ "Groarrrrrrrrrr!"
        [/message]

        [message]
            speaker=Captain
            #po: over yonder means over there.
            message= _ "Now here is an ill fate. A great sea serpent over yonder has taken notice to us."
        [/message]

        [message]
            speaker=Kai
            message= _ "A great sea serpent?! In our peoples myth and legend it is recorded that sea serpents drove our ancestors out of their ancient ocean cities, forcing them to forge their empire anew along the coast. Only in myth did I think such terrible creatures existed."
        [/message]

        [message]
            speaker=Captain
            # TODO: piratice this dialogue arr.
            message= _ "I am afraid they are very real. There is nothing else for it, we must kill this foe, or else be eaten by it. I wish we could help in battle, but our only armed ship is aground and it is hard for us to move on the water."
#ifdef EASY
            _ "Let them come to ground and then we will help get rid of them"
#endif
        [/message]

        [music]
            name=vengeful.ogg
            append=yes
        [/music]

        [objectives]
            side=1
            [objective]
                condition=win
                description= _ "Defeat the enemy leader"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Kai Danielle"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Aresius"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Kahllysta"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Fluctus"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Mirne"
            [/objective]
            [objective]
                caption= _ "Additional win conditions"
                condition=win
                description= _ "Keep Mirne and at least one of his crew alive"
            [/objective]
            [objective]
                condition=win
                description= _ "Look for more survivors"
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    # Pirate Galleon death event
    [event]
        name=die
        first_time_only=no
        [filter]
            type=Transport Galleon
        [/filter]
        # Creating random variable for image spawning
        [set_variable]
            name=wreck
            value=3
            rand=1..2
        [/set_variable]

        [sound]
            name=water-blast.wav
            #repeat=0 TODO - Is this needed? It should not be, else the sound bug returned to wesnoth lmao
        [/sound]

        # Uses random variable 'wreck' to give a 50% chance of each image spawning
        [if]
            [variable]
                name=wreck
                equals=1
            [/variable]
            [then]
                {PLACE_IMAGE scenery/wreck-3.png $x1 $y1}
            [/then]

            [else]
                {PLACE_IMAGE scenery/shipwreck-1.png $x1 $y1}
            [/else]
        [/if]
        {CLEAR_VARIABLE wreck}
    [/event]    

    # Thunder cannon (Thunder Galleon attack) used for the first time
    [event]
        name=attack end
        first_time_only=no
        [if]
            # Checking if the 'thunder cannon' attack has been used from the attack or defender
            [variable]
                name=weapon.name
                equals=thunder cannon
            [/variable]
            [or]
                [variable]
                    name=second_weapon.name
                    equals=thunder cannon
                [/variable]
            [/or]
            # Checking if this event has fired before
            [and]
                [variable]
                    name=first_thunder
                    equals=yes
                [/variable]
            [/and]

            [then] 
                [message]
                    speaker=Kai
                    message= _ "What was that terrible sound?!"
                [/message]

                [message]
                    speaker=Flagship
                    caption= _ "Captain Mirne"
                    message= _ "That would be our thunder cannon. It was gifted to us by the dwarves, this wonderful weapon is paramount for our protection."
                [/message]
                # Setting flag to false so the event fires only once
                {CLEAR_VARIABLE first_thunder}
            [/then]
        [/if]
    [/event]

    # Ship spawning, very rare
    [event]
        name=new_turn
        first_time_only=no
        # Random variable for if the ship will spawn on this turn (turns 12 to 15)
        [set_variable]
            name=spawning_turn
            value=1
            rand=12..15
        [/set_variable]
        [if]
            [variable]
                name=turn_number
                equals=$spawning_turn
            [/variable]
            [and]
                [variable]
                    name=spawned
                    boolean_equals=no
                [/variable]
            [/and]
            [then]
                # Spawns a ship
                [fire_event]
                    name=spawn_ship
                [/fire_event]
            [/then]
        [/if]
        # Spawn moderator - forces spawn if neccessary
        [if]
            # If no ships have spawned in 15 turns, force one to spawn
            # This is done so RNG does not dictate the difficulty
            [variable]
                name=turn_number
                formula="$turn_number % 15 = 0"
            [/variable]
            [and]
                [variable]
                    name=spawned
                    boolean_equals=no
                [/variable]
            [/and]
            [then]
                [fire_event]
                    name=spawn_ship
                [/fire_event]
            [/then]
        [/if]
    [/event]

    # Spawning a ship randomly inside given tile parameters, only one can spawn
    [event]
        name=spawn_ship

        # Finding a random tile within the given ranges
        [random_placement]
            [filter_location]
                x=12-29
                y=1-3
            [/filter_location]
            num_items=1
            variable=placement
            [command]
                [sound]
                    name="horn-signals/horn-1.ogg"
                [/sound]
                # Ship move animation
                {SCROLL_TO $placement.x $placement.y}
                [move_unit_fake]
                    type="Transport Galleon"
                    to_x=$placement.x
                    to_y=$placement.y
                    side=2
                [/move_unit_fake]
                [unit]
                    type=Transport Galleon
                    side=1
                    id=Transport_Galleon_id
                    max_hitpoints=40
                    hitpoints=40
                    x,y=$placement.x,$placement.y
                    facing=se
                [/unit]
                [unstore_unit]
                    variable=Aresius_stored_var
                    x,y=$placement.x,$placement.y
                [/unstore_unit]
                {CLEAR_VARIABLE Aresius_stored_var}
                [message]
                    speaker=Danielle
                    message= _ "Finally, Aresius, you are back."
                [/message]
                [message]
                    speaker=Kahllysta
                    message= _ "We will need that vessel to carry the stranded humans, so keep the monsters away."
                [/message]
            [/command]
        [/random_placement]
    [/event]

    # Add dwarves (side 3) 
    [event]
        name=moveto
        [filter]
            x,y=33,39
            side=1
        [/filter]
        [message]
            speaker=unit
            message= _ "Ey there are survivors here!"
        [/message]
#undef ADD_ID
#define ADD_ID ID
    [+unit]
        id={ID}
    [/unit]
#enddef
        {GENERIC_UNIT 3 {ON_DIFFICULTY (Dwarvish Steelclad) (Dwarvish Fighter) (Dwarvish Fighter)} 33 38}{ADD_ID Dwarf_fighter}
        {GENERIC_UNIT 3 {ON_DIFFICULTY (Dwarvish Stalwart) (Dwarvish Guardsman) (Dwarvish Guardsman)} 33 38}{ADD_ID Dwarf_guard}
        {GENERIC_UNIT 3 {ON_DIFFICULTY (Dwarvish Thunderguard) (Dwarvish Thunderer) (Dwarvish Thunderer)} 33 38}{ADD_ID Dwarf_stick}
        {GENERIC_UNIT 3 {ON_DIFFICULTY (Dwarvish Berserker) (Dwarvish Ulfserker) (Dwarvish Ulfserker)} 33 38}{ADD_ID Dwarf_berserker}
#undef ADD_ID
        {NAMED_LOYAL_UNIT 3 {ON_DIFFICULTY (Dwarvish Explorer) (Dwarvish Pathfinder) (Dwarvish Scout)} 33 38 Gazki "Gazki"}
        [+unit]
            {TRAIT_LOYAL_HERO}
        [/unit]
        [message]
            speaker=Captain
            message= _ "That is the crew from the Steelfarer Vessel!"
        [/message]
        [message]
            speaker=Gazki
            message= _ "Ahg, I told these humans that dwarves are no good at sailing."
        [/message]

        [for]
            end=6
            [do]
                [store_locations]
                    x=30-39
                    y=45
                    terrain=Ww*, Wo*
                    variable=locs
                [/store_locations]
            [/do]
        [/for]

        {GENERIC_UNIT 4 (Sea Serpent) $locs[3].x $locs[3].y}
        {SCROLL_TO $locs[1].x $locs[1].y}
        {GENERIC_UNIT 4 (Cuttle Fish) $locs[2].x $locs[2].y}
        {GENERIC_UNIT 4 (Water Snakelet) $locs[1].x $locs[1].y}
        {GENERIC_UNIT 4 (Water Snakelet) $locs[4].x $locs[4].y}
#ifdef NORMAL
        {GENERIC_UNIT 4 (Water Serpent) $locs[5].x $locs[5].y}
#endif
#ifdef HARD
        {GENERIC_UNIT 4 (Spitting Serpent) $locs[5].x $locs[5].y}
        {GENERIC_UNIT 4 (Water Snakelet) $locs[6].x $locs[6].y}
#endif
        {CLEAR_VARIABLE locs}
        [message]
            speaker=unit
            message= _ "Oh."
        [/message]
        [objectives]
            side=1
            [objective]
                condition=win
                description= _ "Defeat the enemy leader"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Kai Danielle"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Aresius"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Kahllysta"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Fluctus"
            [/objective]
            [objective]
                condition=lose
                description= _ "Death of Mirne"
            [/objective]
            [objective]
                caption= _ "Additional win condition"
                condition=win
                description= _ "Keep Mirne and Gaski and at least one of each crews alive"
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=yes
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    # If you find and save the dwarves you will choose between two random units to keep (forever) at the end of the scenario from sides 2 & 3 TODO: add strong AMLAS for them.
    [event]
        name=victory
        [if]
            [have_unit]
                id=Captain
            [/have_unit]
            [and]
                [have_unit]
                    side=2
                    [not]
                        id=Flagship
                    [/not]
                    count=2-99
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    side=3
                    count=2-99
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    id=Gazki
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    id=Transport_Galleon_id
                [/have_unit]
            [/and]
            [then]
                [store_unit]
                    [filter]
                        side=2
                        [not]
                            id=Captain
                        [/not]
                        [not]
                            id=Flagship
                        [/not]
                    [/filter]
                    variable=choose_unit_side_2
                [/store_unit]
                [store_unit]
                    [filter]
                        side=3
                        [not]
                            id=Gazki
                        [/not]
                    [/filter]
                    variable=choose_unit_side_3
                [/store_unit]
                {RANDOM 1..$choose_unit_side_2.length}
                {VARIABLE random_2 $random}
                {VARIABLE_OP random_2 sub 1}
#ifdef DEBUG_MODE
                [message]
                    speaker=narrator
                    message= _ "Side 2 Unit $random_2"
                [/message]
#endif
                {RANDOM 1..$choose_unit_side_3.length}
                {VARIABLE random_3 $random}
                {VARIABLE_OP random_3 sub 1}
#ifdef DEBUG_MODE
                [message]
                    speaker=narrator
                    message= _ "Side 3 Unit $random_3"
                [/message]
#endif
                [message]
                    speaker=Captain
                    message= _ "You have managed to save us and you have a boat still floating, please, let us come with you and one of us will join you with the upmost loyalty."
                    [option]
                        label= _ "Dwarves are not good on water, I will take your $choose_unit_side_2[$random_2].type."
                        [command]
                            {MODIFY_UNIT id=$choose_unit_side_2[$random_2].id side 1}
                            {SCROLL_TO $choose_unit_side_2[$random_2].x $choose_unit_side_2[$random_2].y}
                        [/command]
                    [/option]
                    [option]
                        label= _ "Humans are not that strong, I will take your $choose_unit_side_3[$random].type."
                        [command]
                            {MODIFY_UNIT id=$choose_unit_side_3[$random].id side 1}
                            {SCROLL_TO $choose_unit_side_3[$random].x $choose_unit_side_3[$random].y}
                        [/command]
                    [/option]
                [/message]
                {CLEAR_VARIABLE random_2,random_3,choose_unit_side_2,choose_unit_side_3}
                [delay]
                    time=1000
                    accelerate=yes
                [/delay]
                [message]
                    speaker=Kai
                    message= _ "Alright then, everyone on board!"
                [/message]
                {VARIABLE stranded 0}
            [/then]
            [else]
                [if]
                    [not]
                        [have_unit]
                            id=Transport_Galleon_id
                        [/have_unit]
                    [/not]
                    [then]
                        [message]
                            speaker=Captain
                            message= _ "Thank you for helping us live for another day, but without a vessel, we will have to stay here, just go to Elensefar and tell them we are here."
                        [/message]
                        {VARIABLE stranded 1}
                    [/then]
                    [else]
                        [message]
                            speaker=Captain
                            message= _ "Thank you for helping us live for another day and for letting us use yer boats."
                        [/message]
                        {VARIABLE stranded 0}
                    [/else]
                [/if]
            [/else]
        [/if]
        {CLEAR_VARIABLE first_thunder,spawned,spawning_turn}
    [/event]

    # Death events
    {VIU_LAST_BREATH Kai (_ "The legends were true, these beasts are strong...")}
    {VIU_LAST_BREATH Aresius (_ "Kai, I have failed you... ughh...")}
    {VIU_LAST_BREATH Fluctus (_ "A war general, beaten by snakes... huh...")}
    {VIU_LAST_BREATH Kahllysta (_ "Beasts...")}
    {VIU_LAST_BREATH Captain (_ "Grab to yer yonkers, I cant believe this is my demise...")}
    {VIU_LAST_BREATH Gazki (_ "This is no place for a dwarf to die, may these volcanoes erupt one day and create the biggest of the mountains for me to rest...")}
[/scenario]
